from flask import jsonify
from sqlalchemy import func, and_
from datetime import datetime, timedelta

@app.route("/api/companies/<int:company_id>/alerts/low-stock", methods=["GET"])
def low_stock_alerts(company_id):
    """
    Returns low-stock alerts for all warehouses of a company
    """

    THIRTY_DAYS_AGO = datetime.utcnow() - timedelta(days=30)

    # 1. Verify company exists
    company = Company.query.get(company_id)
    if not company:
        return jsonify({"error": "Company not found"}), 404

    alerts = []

    # 2. Get all warehouses for company
    warehouses = Warehouse.query.filter_by(company_id=company_id).all()

    if not warehouses:
        return jsonify({"alerts": [], "total_alerts": 0}), 200

    for warehouse in warehouses:
        # 3. Join inventory + product + threshold
        inventory_rows = (
            db.session.query(
                Inventory,
                Product,
                ProductThreshold.low_stock_threshold
            )
            .join(Product, Product.id == Inventory.product_id)
            .join(
                ProductThreshold,
                ProductThreshold.product_type == Product.product_type
            )
            .filter(Inventory.warehouse_id == warehouse.id)
            .all()
        )

        for inventory, product, threshold in inventory_rows:
            # Skip if stock is not low
            if inventory.quantity >= threshold:
                continue

            # 4. Check recent sales activity
            sales = (
                db.session.query(func.sum(InventoryTransaction.quantity_change))
                .filter(
                    InventoryTransaction.product_id == product.id,
                    InventoryTransaction.warehouse_id == warehouse.id,
                    InventoryTransaction.quantity_change < 0,
                    InventoryTransaction.created_at >= THIRTY_DAYS_AGO
                )
                .scalar()
            )

            if not sales:
                continue  # No recent sales → no alert

            avg_daily_sales = abs(sales) / 30

            days_until_stockout = (
                int(inventory.quantity / avg_daily_sales)
                if avg_daily_sales > 0 else None
            )

            # 5. Fetch supplier info
            supplier = (
                db.session.query(Supplier)
                .join(SupplierProduct)
                .filter(SupplierProduct.product_id == product.id)
                .first()
            )

            alerts.append({
                "product_id": product.id,
                "product_name": product.name,
                "sku": product.sku,
                "warehouse_id": warehouse.id,
                "warehouse_name": warehouse.name,
                "current_stock": inventory.quantity,
                "threshold": threshold,
                "days_until_stockout": days_until_stockout,
                "supplier": {
                    "id": supplier.id if supplier else None,
                    "name": supplier.name if supplier else None,
                    "contact_email": supplier.contact_email if supplier else None
                }
            })

    return jsonify({
        "alerts": alerts,
        "total_alerts": len(alerts)
    }), 200

2. Approach Explanation 
1. Company & Warehouse Scope
A.	The inquiry is limited to the business.
B.	iterates over all of the company's warehouses.
Why?
A. Business rules specifically call for handling many warehouses.
2. Threshold by Product Type
A. ProductThreshold.low_stock_threshold
Why:
•	Avoids hard-coding thresholds
•	Allows product teams to adjust thresholds without redeploying

3. Recent Sales Filter
quantity_change < 0
created_at >= last_30_days
Why:
•	Prevents alerts for dead or discontinued products
•	Ensures alerts are actionable

4. Days Until Stockout Calculation
avg_daily_sales = abs(sales) / 30
Why:
•	Simple, explainable heuristic
•	Works well for alerting (not forecasting)
Edge handling:
•	No sales → None
•	Avoids divide-by-zero

5. Supplier Lookup
SupplierProduct → Supplier
Why:
•	Enables immediate reordering
•	Keeps alert payload operational, not just informational

3. Edge Cases Handled
Scenario	Behavior
Company not found	404
No warehouses	Empty alerts
No recent sales	Product ignored
No supplier	Supplier fields set to null
Zero sales velocity	days_until_stockout = null
Multiple warehouses	Alerts returned per warehouse

Assumptions (Documented Explicitly)
Based on prior schema discussions and the incomplete requirements, I assume:
1.	Tables
o	companies(id)
o	warehouses(id, company_id, name)
o	products(id, name, sku, product_type)
o	inventory(product_id, warehouse_id, quantity)
o	inventory_transactions(product_id, warehouse_id, quantity_change, created_at)
o	suppliers(id, name, contact_email)
o	supplier_products(supplier_id, product_id)
o	product_thresholds(product_type, low_stock_threshold)
	Example: simple → 20, bundle → 5
2.	Recent sales activity
o	Defined as at least one negative inventory transaction (sale)
o	Within the last 30 days
3.	Days until stockout
o	Calculated using average daily sales over last 30 days
o	If no sales velocity → return null
4.	One primary supplier per product
o	Chosen arbitrarily as the first supplier record
